<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ELP Relat√≥rios - Login</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="./static/css/style.css" rel="stylesheet">
    <link href="./static/css/mobile.css" rel="stylesheet">

    <!-- PWA Manifest -->
    <link rel="manifest" href="./static/manifest.json">
    <meta name="theme-color" content="#20c1e8">

    <style>
        body {
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .logo-container {
            background: linear-gradient(135deg, #20c1e8 0%, #1a9cb8 100%);
            padding: 2rem;
            border-radius: 1rem 1rem 0 0;
            color: white;
            text-align: center;
        }

        .offline-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
</head>

<body>

    <!-- Offline indicator -->
    <div id="offlineIndicator" class="offline-badge d-none">
        <span class="badge bg-warning text-dark">
            <i class="fas fa-wifi-slash me-1"></i>Offline
        </span>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-5 col-lg-4">
                <div class="card">
                    <div class="logo-container">
                        <i class="fas fa-hard-hat fa-3x mb-3"></i>
                        <h3 class="mb-0">ELP Relat√≥rios</h3>
                        <small>Acompanhamento de Obras</small>
                    </div>
                    <div class="card-body p-4">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Usu√°rio ou E-mail</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" id="username" required autofocus>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="password" class="form-label">Senha</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="loginBtn">
                                    <i class="fas fa-sign-in-alt me-2"></i>Entrar
                                </button>
                            </div>
                        </form>

                        <div id="errorAlert" class="alert alert-danger mt-3 d-none" role="alert"></div>
                        <div id="offlineAlert" class="alert alert-warning mt-3 d-none" role="alert">
                            <i class="fas fa-wifi-slash me-2"></i>Modo offline - usando dados em cache
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3 text-muted">
                    <small>v2.0 - Offline First</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="./js/db.js"></script>
    <script src="./js/api.js"></script>
    <script src="./js/sync.js"></script>
    <script>
        // Check if already logged in
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                window.location.href = 'dashboard.html';
            }

            // Monitor network status
            updateNetworkStatus();
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
        });

        function updateNetworkStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (!navigator.onLine) {
                indicator.classList.remove('d-none');
            } else {
                indicator.classList.add('d-none');
            }
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            const errorAlert = document.getElementById('errorAlert');
            const offlineAlert = document.getElementById('offlineAlert');

            // Reset alerts
            errorAlert.classList.add('d-none');
            offlineAlert.classList.add('d-none');
            errorAlert.textContent = '';

            // UI Loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Entrando...';

            try {
                // Check network status first
                if (navigator.onLine) {
                    try {
                        console.log('üåê Attempting online login...');
                        const response = await api.login(username, password);
                        console.log('‚úÖ Online login successful');

                        // Success - redirect
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 500);
                        return;

                    } catch (onlineError) {
                        console.error('‚ùå Online login failed:', onlineError);

                        const errorMsg = onlineError.message || '';

                        // CRITICAL: If server error, STOP and warn user. Do NOT go offline mode if server is just broken.
                        if (errorMsg.includes('500') || errorMsg.includes('502') || errorMsg.includes('503') || errorMsg.includes('Service Unavailable') || errorMsg.includes('Internal Server Error')) {
                            throw new Error('Servidor indispon√≠vel temporariamente (Erro 5xx). Tente novamente em 2 minutos.');
                        }

                        // If invalid credentials, STOP.
                        if (errorMsg.includes('401') || errorMsg.includes('Unauthorized') || errorMsg.includes('Credenciais')) {
                            throw new Error('Usu√°rio ou senha incorretos.');
                        }

                        // Only fallback if it's a network error (e.g. timeout, DNS, fetch failed)
                        if (!errorMsg.includes('Failed to fetch') && !errorMsg.includes('Network')) {
                            // If it's some other API error, throw it
                            throw new Error(errorMsg || 'Erro desconhecido no servidor.');
                        }

                        console.warn('‚ö†Ô∏è Network error detected, trying offline fallback...');
                        // Fallthrough to offline attempt
                    }
                } else {
                    console.log('üì¥ Offline detected, trying offline login...');
                }

                // Offline mode / Fallback - use cached credentials
                try {
                    const response = await api.offlineLogin(username, password);
                    console.log('‚úÖ Offline login successful');
                    offlineAlert.classList.remove('d-none');

                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                } catch (offlineError) {
                    console.error('‚ùå Offline login failed:', offlineError);
                    // Normalize error message for user
                    if (offlineError.message && offlineError.message.includes('No credentials')) {
                        throw new Error('Voc√™ precisa fazer login online pelo menos uma vez antes de usar o modo offline.');
                    } else if (offlineError.message && offlineError.message.includes('mismatch')) {
                        throw new Error('Senha incorreta (modo offline).');
                    } else {
                        throw new Error('N√£o foi poss√≠vel conectar ao servidor e n√£o h√° dados salvos para este usu√°rio.');
                    }
                }

            } catch (error) {
                console.error('üõë Final Login Error:', error);
                errorAlert.textContent = error.message.replace('Error:', '').trim();
                errorAlert.classList.remove('d-none');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Entrar';
            }
        });
    </script>

</body>

</html>