<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Relat√≥rio - ELP Relat√≥rios</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="./static/css/style.css" rel="stylesheet">
    <link href="./static/css/mobile.css" rel="stylesheet">

    <style>
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .photo-item .badge {
            position: absolute;
            bottom: 5px;
            left: 5px;
        }

        .fab-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 24px;
            z-index: 1000;
        }
    </style>
</head>

<body class="bg-light">

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark py-3 px-4 shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-arrow-left me-2"></i>Novo Relat√≥rio
            </a>
            <button id="saveDraftBtn" class="btn btn-outline-light btn-sm">
                <i class="fas fa-save me-1"></i>Salvar Rascunho
            </button>
        </div>
    </nav>

    <div class="container mt-4 mb-5 pb-5">
        <form id="reportForm">
            <!-- Project Selection -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-building me-2"></i>Projeto</h5>
                    <select class="form-select" id="projectSelect" required>
                        <option value="">Carregando projetos...</option>
                    </select>
                </div>
            </div>

            <!-- Basic Info -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>Informa√ß√µes B√°sicas</h5>

                    <div class="mb-3">
                        <label for="reportDate" class="form-label">Data do Relat√≥rio</label>
                        <input type="date" class="form-control" id="reportDate" required>
                    </div>

                    <div class="mb-3">
                        <label for="reportTitle" class="form-label">T√≠tulo</label>
                        <input type="text" class="form-control" id="reportTitle"
                            placeholder="Ex: Visita t√©cnica - Fachada">
                    </div>

                    <div class="mb-3">
                        <label for="weatherConditions" class="form-label">Condi√ß√µes Clim√°ticas</label>
                        <select class="form-select" id="weatherConditions">
                            <option value="Ensolarado">‚òÄÔ∏è Ensolarado</option>
                            <option value="Parcialmente Nublado">‚õÖ Parcialmente Nublado</option>
                            <option value="Nublado">‚òÅÔ∏è Nublado</option>
                            <option value="Chuvoso">üåßÔ∏è Chuvoso</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-file-alt me-2"></i>Descri√ß√£o</h5>
                    <textarea class="form-control" id="reportDescription" rows="6"
                        placeholder="Descreva o andamento da obra, servi√ßos executados, observa√ß√µes..."></textarea>
                </div>
            </div>

            <!-- Photos -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-camera me-2"></i>Fotos
                        <span class="badge bg-primary" id="photoCount">0</span>
                    </h5>

                    <button type="button" class="btn btn-primary w-100" id="capturePhotoBtn">
                        <i class="fas fa-camera me-2"></i>Capturar Foto
                    </button>

                    <div id="photoGrid" class="photo-grid"></div>
                </div>
            </div>

            <!-- Observations -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-comment me-2"></i>Observa√ß√µes Finais</h5>
                    <textarea class="form-control" id="reportObservations" rows="4"
                        placeholder="Observa√ß√µes adicionais, pend√™ncias, pr√≥ximos passos..."></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2">
                <button type="button" id="submitBtn" class="btn btn-success btn-lg">
                    <i class="fas fa-paper-plane me-2"></i>Enviar para Aprova√ß√£o
                </button>
                <button type="button" id="saveDraftBtn2" class="btn btn-outline-secondary">
                    <i class="fas fa-save me-2"></i>Salvar como Rascunho
                </button>
            </div>
        </form>
    </div>

    <!-- Floating Action Button for Quick Photo -->
    <button class="fab-button" id="fabPhotoBtn" title="Capturar Foto">
        <i class="fas fa-camera"></i>
    </button>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="./js/db.js"></script>
    <script src="./js/api.js"></script>
    <script src="./js/sync.js"></script>
    <script src="./js/camera.js"></script>
    <script>
        let currentReportId = null;
        let photos = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }

            // Generate local report ID
            currentReportId = `local_${Date.now()}`;

            // Set default date to today
            document.getElementById('reportDate').valueAsDate = new Date();

            // Load projects
            await loadProjects();

            // Photo capture buttons
            document.getElementById('capturePhotoBtn').addEventListener('click', capturePhoto);
            document.getElementById('fabPhotoBtn').addEventListener('click', capturePhoto);

            // Save draft buttons
            document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
            document.getElementById('saveDraftBtn2').addEventListener('click', saveDraft);

            // Submit button
            document.getElementById('submitBtn').addEventListener('click', submitReport);

            // Load existing photos if any
            await loadPhotos();
        });

        async function loadProjects() {
            try {
                let projects = await db.projects.getItem('all') || [];

                if (projects.length === 0 && navigator.onLine) {
                    projects = await api.get('/projects');
                    await db.projects.setItem('all', projects);
                }

                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">Selecione um projeto</option>';

                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.numero} - ${p.nome}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        async function capturePhoto() {
            try {
                const photoData = await photoManager.capturePhoto(currentReportId);
                photos.push(photoData);
                renderPhotos();
            } catch (error) {
                alert('Erro ao capturar foto: ' + error.message);
            }
        }

        async function loadPhotos() {
            photos = await photoManager.getPhotosForReport(currentReportId);
            renderPhotos();
        }

        function renderPhotos() {
            const grid = document.getElementById('photoGrid');
            const count = document.getElementById('photoCount');

            count.textContent = photos.length;

            if (photos.length === 0) {
                grid.innerHTML = '<p class="text-muted text-center mt-3">Nenhuma foto adicionada</p>';
                return;
            }

            grid.innerHTML = photos.map(photo => `
                <div class="photo-item">
                    <img src="data:image/jpeg;base64,${photo.thumbnail}" alt="Foto">
                    <button class="delete-btn" onclick="deletePhoto('${photo.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                    ${!photo.synced ? '<span class="badge bg-warning">Offline</span>' : ''}
                </div>
            `).join('');
        }

        async function deletePhoto(photoId) {
            if (!confirm('Deseja excluir esta foto?')) return;

            await photoManager.deletePhoto(photoId);
            photos = photos.filter(p => p.id !== photoId);
            renderPhotos();
        }

        async function saveDraft() {
            const reportData = getFormData();
            reportData.status = 'Rascunho';

            await saveReport(reportData);
            alert('Rascunho salvo com sucesso!');
        }

        async function submitReport() {
            if (!document.getElementById('reportForm').checkValidity()) {
                alert('Por favor, preencha todos os campos obrigat√≥rios');
                return;
            }

            const reportData = getFormData();
            reportData.status = 'Aguardando Aprova√ß√£o';

            await saveReport(reportData);

            if (navigator.onLine) {
                alert('Relat√≥rio enviado para aprova√ß√£o!');
            } else {
                alert('Relat√≥rio salvo! Ser√° enviado quando houver conex√£o.');
            }

            window.location.href = 'relatorios.html';
        }

        function getFormData() {
            return {
                id: currentReportId,
                projeto_id: document.getElementById('projectSelect').value,
                data_relatorio: document.getElementById('reportDate').value,
                titulo: document.getElementById('reportTitle').value,
                condicoes_climaticas: document.getElementById('weatherConditions').value,
                descricao: document.getElementById('reportDescription').value,
                observacoes: document.getElementById('reportObservations').value,
                fotos: photos.map(p => p.id),
                created_at: new Date().toISOString(),
                _isLocal: true
            };
        }

        async function saveReport(reportData) {
            // Save to IndexedDB
            const allReports = await db.reports.getItem('all') || [];
            const index = allReports.findIndex(r => r.id === reportData.id);

            if (index >= 0) {
                allReports[index] = reportData;
            } else {
                allReports.push(reportData);
            }

            await db.reports.setItem('all', reportData.id);
            await db.reports.setItem(reportData.id, reportData);

            // Queue for sync if online
            if (navigator.onLine && reportData.status === 'Aguardando Aprova√ß√£o') {
                try {
                    await api.post('/reports/create', reportData);
                } catch (error) {
                    console.warn('Failed to sync report, will retry later');
                }
            }
        }
    </script>
</body>

</html>